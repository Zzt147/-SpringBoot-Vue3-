import{T as Q}from"./Top-Bn4jeg1z.js";import{m as D,p as j,r as m,A as S,a as x,b as l,o,e as a,f as v,t as r,u as M,h as L,F,l as U,d as n,w as c,g as N,J as g,i as W,c as E,j as X,K as Y,E as R,L as Z,B as ee,H as te}from"./index-DSKI6YI0.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ae={class:"comment-item"},se={class:"main-comment"},ne={class:"user-avatar"},le=["src"],oe={class:"content-box"},ie={class:"user-info"},ce={class:"username"},re={class:"floor-tag"},me={class:"comment-text"},ue={class:"comment-actions"},de={class:"time-text"},pe={key:0,class:"location-text",style:{"margin-left":"10px",color:"#999","font-size":"12px"}},_e={key:0,class:"sub-reply-container"},fe={class:"reply-line"},ve=["src"],ge={class:"reply-user"},he={key:0,style:{color:"#409EFF",margin:"0 4px","font-size":"12px"}},ye={key:1,class:"reply-colon"},xe={class:"reply-text"},Ce={class:"reply-actions"},ke={class:"time-text"},be={key:0,class:"location-text",style:{"margin-left":"10px",color:"#999","font-size":"12px"}},we=["onClick"],$e={key:1,class:"reply-input-box"},Ie={style:{"text-align":"right"}},Ae={__name:"Comment",props:["comment","floor"],setup(u){const h=u,w=D(),C=j("axios"),i=m([]),k=m(1),_=m(5),d=m(0),$=m(!1),p=m(!1),f=m(""),y=m("回复层主..."),A=m(null);function b(){C.get(`/api/reply/getReplies?commentId=${h.comment.id}&page=${k.value}&rows=${_.value}&_t=${new Date().getTime()}`).then(e=>{e.data.success&&(i.value=e.data.map.replies||[],d.value=e.data.map.total||0)}).catch(e=>console.error("加载回复失败",e))}function T(){$.value?(_.value=5,b()):(_.value=100,b()),$.value=!$.value}function V(e){if(!w.user.user){g.warning("请先登录！");return}e?(A.value=e.id,y.value=`回复 @${e.username}:`):(A.value=null,y.value=`回复 @${h.comment.author}:`),p.value=!0,f.value=""}function B(){if(!f.value.trim()){g.warning("请输入回复内容");return}let e={content:f.value,commentId:h.comment.id,userId:w.user.user.id,toUid:A.value};C.post("/api/reply/insert",e).then(t=>{t.data.success?(g.success("回复成功"),p.value=!1,f.value="",b()):g.error(t.data.msg||"回复失败")}).catch(()=>g.error("系统繁忙"))}return S(()=>{h.comment.id&&b()}),(e,t)=>{const H=x("el-input"),z=x("el-button");return o(),l("div",ae,[a("div",se,[a("div",ne,[a("img",{src:u.comment.avatar||"/api/images/default.png",alt:"avatar"},null,8,le)]),a("div",oe,[a("div",ie,[a("span",ce,r(u.comment.author),1),a("span",re,"#"+r(u.floor)+"楼",1)]),a("div",me,r(u.comment.content),1),a("div",ue,[a("span",de,r(M(L)(u.comment.created,"yyyy-MM-dd HH:mm:ss")),1),u.comment.location?(o(),l("span",pe," IP属地："+r(u.comment.location),1)):v("",!0),a("span",{class:"action-btn",onClick:t[0]||(t[0]=s=>V(null))},"回复")])])]),i.value.length>0||p.value?(o(),l("div",_e,[(o(!0),l(F,null,U(i.value,s=>(o(),l("div",{key:s.id,class:"reply-item"},[a("div",fe,[a("img",{class:"mini-avatar",src:s.avatar||"/api/images/default.png"},null,8,ve),a("span",ge,r(s.username),1),s.targetName?(o(),l("span",he," 回复 @"+r(s.targetName)+" : ",1)):(o(),l("span",ye," : ")),a("span",xe,r(s.content),1)]),a("div",Ce,[a("span",ke,r(M(L)(s.created,"yyyy-MM-dd HH:mm:ss")),1),u.comment.location?(o(),l("span",be," IP属地："+r(u.comment.location),1)):v("",!0),a("span",{class:"action-btn",onClick:I=>V({id:s.userId,username:s.username})}," 回复 ",8,we)])]))),128)),d.value>5?(o(),l("div",{key:0,class:"expand-btn",onClick:T},r($.value?"收起回复":`查看剩余 ${d.value-i.value.length} 条回复`),1)):v("",!0),p.value?(o(),l("div",$e,[n(H,{modelValue:f.value,"onUpdate:modelValue":t[1]||(t[1]=s=>f.value=s),placeholder:y.value,size:"small",style:{"margin-bottom":"5px"}},null,8,["modelValue","placeholder"]),a("div",Ie,[n(z,{size:"small",onClick:t[2]||(t[2]=s=>p.value=!1)},{default:c(()=>[...t[3]||(t[3]=[N("取消",-1)])]),_:1}),n(z,{type:"primary",size:"small",onClick:B},{default:c(()=>[...t[4]||(t[4]=[N("发送",-1)])]),_:1})])])):v("",!0)])):v("",!0)])}}},Re=J(Ae,[["__scopeId","data-v-8f9a8b4b"]]),Me={style:{"text-align":"center","margin-top":"20px","font-size":"28px"}},Ve={style:{"text-align":"center",color:"#999","margin-bottom":"20px"}},ze={key:0},Pe=["innerHTML"],Te=["infinite-scroll-disabled"],Be={key:0,class:"infinite-list-item"},He={key:0,style:{"text-align":"center",color:"#999"}},Ee={key:1,style:{"text-align":"center",color:"#999","padding-bottom":"20px"}},Fe={key:2,style:{"text-align":"center",color:"#999",padding:"20px"}},Ne={__name:"ArticleAndComment",setup(u){const h=Y(),w=j("axios"),C=D();let i=W({article:{content:""},comments:[]}),k={page:1,rows:5};const _=m(!1),d=m(!1),$=E(()=>d.value||_.value),p=m(""),f=m(!1),y=E(()=>i.comments.filter(e=>e&&e.id));X(()=>C.user.user,e=>{A(e)},{immediate:!0});function A(e){e&&e.authorities&&e.authorities[0]=="ROLE_common"?f.value=!0:f.value=!1}S(()=>{b()});function b(){w({method:"post",url:"/api/article/getArticleAndFirstPageCommentByArticleId?articleId="+h.params.articleId,data:k}).then(e=>{e.data.success?e.data.map.article!=null?(i.article=e.data.map.article,i.comments=e.data.map.comments||[],(!e.data.map.comments||e.data.map.comments.length<k.rows)&&(_.value=!0)):R.alert("无文章！","结果"):R.alert(e.data.msg,"结果")}).catch(e=>{console.error(e),R.alert("系统错误！","结果")})}const T=E(()=>i.article.content?Z.parse(i.article.content):""),V=()=>{d.value||_.value||(d.value=!0,k.page++,w({method:"post",url:"/api/comment/getAPageCommentByArticleId?articleId="+h.params.articleId,data:k}).then(e=>{if(e.data.success){let t=e.data.map.comments;t&&t.length>0?i.comments.push(...t):_.value=!0}else R.alert(e.data.msg,"结果");d.value=!1}).catch(()=>{d.value=!1,R.alert("系统错误！","结果")}))};function B(){if(!C.user.user){g.warning("请先登录！");return}if(!p.value.trim()){g.warning("评论内容不能为空！");return}w({method:"post",url:"/api/comment/insert",data:{articleId:h.params.articleId,content:p.value,author:C.user.user.username||C.user.user.name}}).then(e=>{if(e.data.success){g.success("评论成功"),p.value="";const t=e.data.map.Comment||e.data.map.comment;t?i.comments.unshift(t):(k.page=1,_.value=!1,i.comments=[],b())}else g.error(e.data.msg)}).catch(()=>{g.error("系统错误")})}return(e,t)=>{const H=x("el-affix"),z=x("el-divider"),s=x("el-col"),I=x("el-row"),K=x("el-input"),O=x("el-button"),q=ee("infinite-scroll");return o(),l(F,null,[n(H,null,{default:c(()=>[n(Q)]),_:1}),n(I,null,{default:c(()=>[n(s,{span:14,offset:5},{default:c(()=>[a("h1",Me,r(M(i).article.title),1),a("div",Ve,[M(i).article.created?(o(),l("span",ze," 发布于: "+r(M(i).article.created),1)):v("",!0)]),n(z)]),_:1})]),_:1}),n(I,null,{default:c(()=>[n(s,{span:14,offset:5},{default:c(()=>[a("div",{innerHTML:T.value,class:"markdown-body"},null,8,Pe)]),_:1})]),_:1}),n(I,{style:{"background-color":"#f7f7f7","margin-top":"20px"}},{default:c(()=>[n(s,{span:14,offset:5},{default:c(()=>[te((o(),l("ul",{"infinite-scroll-disabled":$.value,class:"infinite-list"},[f.value?(o(),l("li",Be,[n(I,null,{default:c(()=>[n(s,null,{default:c(()=>[n(K,{modelValue:p.value,"onUpdate:modelValue":t[0]||(t[0]=P=>p.value=P),autosize:{minRows:4},type:"textarea",placeholder:"写下你的评论...",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1}),n(I,{justify:"end"},{default:c(()=>[n(s,{xs:8,sm:6,md:4},{default:c(()=>[n(O,{onClick:B,type:"primary",round:"",style:{"margin-top":"10px"}},{default:c(()=>[...t[1]||(t[1]=[N(" 提交评论 ",-1)])]),_:1})]),_:1})]),_:1})])):v("",!0),(o(!0),l(F,null,U(y.value,(P,G)=>(o(),l("li",{key:P.id,class:"infinite-list-item"},[n(Re,{comment:P,floor:y.value.length-G},null,8,["comment","floor"])]))),128))],8,Te)),[[q,V]]),d.value?(o(),l("p",He,"加载中...")):v("",!0),_.value&&y.value.length>0?(o(),l("p",Ee," 没有更多评论了")):v("",!0),y.value.length===0&&!d.value?(o(),l("p",Fe," 暂无评论，快来抢沙发吧！")):v("",!0)]),_:1})]),_:1})],64)}}},Se=J(Ne,[["__scopeId","data-v-750474aa"]]);export{Se as default};
